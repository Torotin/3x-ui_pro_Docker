# === CrowdSec Firewall Bouncer configuration ===
# Оптимизировано для: iptables + Docker + UFW + host network
# ┌─────────────────────────┐
# │   1. INPUT (policy DROP)│  ← начинается здесь
# └─────────────┬───────────┘
#               │
#               ▼
# ┌─────────────────────────┐
# │ 2. CROWDSEC_CHAIN       │  ← вставлено бонсером
# │    • ipset blacklist    │
# │    • DROP (если в бане) │
# └─────────────┬───────────┘
#               │
#               ▼
# ┌─────────────────────────┐
# │ 3. ufw-before-logging   │
# └─────────────┬───────────┘
#               │
#               ▼
# ┌─────────────────────────┐
# │ 4. ufw-before-input     │  ← основной UFW filter
# │    • allow established  │
# │    • allow lo           │
# │    • ICMP allow         │
# │    • reject invalid     │
# └─────────────┬───────────┘
#               │
#               ▼
# ┌─────────────────────────┐
# │ 5. ufw-user-input       │  ← пользовательские правила
# │    • allow ssh          │
# │    • allow 80/443       │
# └─────────────┬───────────┘
#               │
#               ▼
# ┌─────────────────────────┐
# │ 6. ufw-after-input      │
# └─────────────┬───────────┘
#               │
#               ▼
# ┌─────────────────────────┐
# │ 7. ufw-after-logging    │
# └─────────────┬───────────┘
#               │
#               ▼
# ┌─────────────────────────┐
# │ 8. POLICY (DROP)        │ ← если ничего не разрешено
# └─────────────────────────┘
# ===============================================


mode: iptables

update_frequency: 10s

log_mode: file
log_dir: /var/log/
log_level: info
log_compression: true
log_max_size: 100
log_max_backups: 3
log_max_age: 30

api_url: http://${CROWDSEC_API}/
api_key: ${API_KEY}

insecure_skip_verify: false
disable_ipv6: false

deny_action: DROP
deny_log: false

supported_decisions_types:
  - ban

# Имя ipset-наборов для блокировки
blacklists_ipv4: crowdsec-blacklists
blacklists_ipv6: crowdsec6-blacklists

ipset_type: nethash

# Цепочки iptables, в которые бонсер будет вставлять CROWDSEC_CHAIN
# Важно: только INPUT + DOCKER-USER, т.к. FORWARD ломает Docker networking
iptables_chains:
  - INPUT
#  - FORWARD
  - DOCKER-USER

iptables_add_rule_comments: true

# nftables отключены, чтобы исключить дублирование и конфликты
nftables:
  ipv4:
    enabled: false
  ipv6:
    enabled: false

nftables_hooks: []

# pf выключен
pf:
  anchor_name: ""

prometheus:
  enabled: false
  listen_addr: 127.0.0.1
  listen_port: 60601
