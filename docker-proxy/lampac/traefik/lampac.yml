# /dynamic/lampac.yml (оптимизированная версия)

http:
  routers:
    # CORS preflight - оптимизированный
    lampac-preflight:
      rule: "Host(`${WEBDOMAIN}`) && Method(`OPTIONS`)"
      entryPoints:
        - websecure
      middlewares:
        - lampac-unified-headers@file
      service: noop@internal
      priority: 1000

    # API proxy endpoints
    lampac-proxy:
      rule: "Host(`${WEBDOMAIN}`) && (PathPrefix(`/proxy/`) || PathPrefix(`/proxy-dash/`))"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 900

    # JavaScript файлы
    lampac-scripts:
      rule: "Host(`${WEBDOMAIN}`) && PathRegexp(`^/(.*)\\.js$`) && !PathRegexp(`^/.+/js/.+$`)"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 800

    # Изображения
    lampac-images:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/proxyimg`)"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 700

    # WebSocket - упрощенный
    lampac-websocket:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/ws`)"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 600

    # Native WebSocket - упрощенный
    lampac-nws:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/nws`)"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 650

    # SignalR Hub - упрощенный
    lampac-signalr:
      rule: "Host(`${WEBDOMAIN}`) && (PathPrefix(`/hub`) || PathPrefix(`/signalr`) || PathPrefix(`/hubs`))"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 700

    # CUB Proxy
    lampac-cub:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/cub/`)"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 750

    # TMDB Proxy
    lampac-tmdb:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/tmdb/`)"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 750

    # GitHub Proxy для обхода CORS
    lampac-github:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/github/`)"
      service: github-proxy@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-github-headers@file
      priority: 750

    # Основное приложение - исключаем пути 3x-ui и xhttp
    lampac-main:
      rule: "Host(`${WEBDOMAIN}`) && !PathPrefix(`/${URI_PANEL_PATH}`) && !PathPrefix(`${URI_SUB_PATH}`) && !PathPrefix(`${URI_JSON_PATH}`) && !PathPrefix(`${URI_VLESS_XHTTP}`)"
      service: lampac-service@file
      entryPoints:
        - websecure
      tls:
        certResolver: le
      middlewares:
        - lampac-unified-chain@file
      priority: 500

  services:
    # Основной сервис Lampac - оптимизированный
    lampac-service:
      loadBalancer:
        passHostHeader: true
        servers:
          - url: "http://lampac:9118"
        healthCheck:
          path: "/ping"
          interval: "15s"
          timeout: "5s"
        # Улучшенная буферизация (интегрирована в middleware)
        # buffering настройки теперь в lampac-buffering middleware

    # GitHub прокси сервис
    github-proxy:
      loadBalancer:
        passHostHeader: true
        servers:
          - url: "https://api.github.com"

  middlewares:
    # Оптимизированные цепочки middleware для разных типов контента
    
    # Единая цепочка для всех типов контента
    lampac-unified-chain:
      chain:
        middlewares:
          - lampac-unified-headers@file
          - lampac-circuit-breaker@file
          - lampac-rate-limit@file
          - compress@file

    # Единый middleware для всех заголовков
    lampac-unified-headers:
      headers:
        # TLS / HSTS
        sslRedirect: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true

        # MIME & XSS
        contentTypeNosniff: true
        browserXssFilter: true
        frameDeny: false
        referrerPolicy: "no-referrer-when-downgrade"

        # Единые заголовки для всех типов контента
        customResponseHeaders:
          # Безопасность
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
          
          # CORS для всех запросов
          Access-Control-Allow-Origin: "*"
          Access-Control-Allow-Methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS, HEAD"
          Access-Control-Allow-Headers: "Accept, Origin, Content-Type, Authorization, X-Requested-With, X-Signalr-User-Agent, Cache-Control, DNT, If-Modified-Since, Keep-Alive, User-Agent, Token, Profile, X-Forwarded-For, X-Forwarded-Proto, X-Real-IP, CF-Connecting-IP, Sec-WebSocket-Key, Sec-WebSocket-Version, Sec-WebSocket-Protocol, Sec-WebSocket-Accept, Connection, Upgrade"
          Access-Control-Allow-Credentials: "true"
          Access-Control-Allow-Private-Network: "true"
          Access-Control-Max-Age: "86400"
          Access-Control-Expose-Headers: "Content-Length, Content-Type, Date, Server, X-Request-ID"
          
          # Отключение CSP для полной совместимости
          # Content-Security-Policy: "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:; script-src * 'unsafe-inline' 'unsafe-eval' data: blob:; worker-src * 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src *; img-src * data: blob:; style-src * 'unsafe-inline'; font-src * data:; frame-src *; object-src *; media-src *;"
          
          # Принудительное отключение кэширования для CSP
          Cache-Control: "no-cache, no-store, must-revalidate"
          Pragma: "no-cache"
          Expires: "0"
          Vary: "Accept-Encoding, Origin"
          
          # Скрытие информации о сервере
          server: ""
          X-Powered-By: ""

    # Rate limiting (упрощенный)
    lampac-rate-limit:
      rateLimit:
        burst: 100
        average: 50
        period: "1m"
        sourceCriterion:
          ipStrategy:
            depth: 1
            excludedIPs:
              - "127.0.0.1/32"
              - "172.16.0.0/12"
              - "172.18.0.0/16"
              - "172.20.0.0/16"

    # Circuit breaker - защита от каскадных сбоев
    lampac-circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.3 || ResponseCodeRatio(500, 600, 0, 600) > 0.3"
        checkPeriod: "10s"
        fallbackDuration: "30s"
        recoveryDuration: "10s"

    # Специальные заголовки для WebSocket
    lampac-websocket-headers:
      headers:
        # Минимальные заголовки для WebSocket
        customResponseHeaders:
          # CORS для WebSocket
          Access-Control-Allow-Origin: "*"
          Access-Control-Allow-Methods: "GET, POST, OPTIONS"
          Access-Control-Allow-Headers: "Accept, Origin, Content-Type, Authorization, X-Requested-With, Sec-WebSocket-Key, Sec-WebSocket-Version, Sec-WebSocket-Protocol, Sec-WebSocket-Accept, Connection, Upgrade"
          Access-Control-Allow-Credentials: "true"
          Access-Control-Max-Age: "86400"
          
          # WebSocket специфичные заголовки (убраны неправильные заголовки)
          
          # Отключение кэширования для WebSocket
          Cache-Control: "no-cache, no-store, must-revalidate"
          Pragma: "no-cache"
          Expires: "0"

    # GitHub прокси заголовки
    lampac-github-headers:
      headers:
        customResponseHeaders:
          # CORS для GitHub API
          Access-Control-Allow-Origin: "*"
          Access-Control-Allow-Methods: "GET, POST, OPTIONS"
          Access-Control-Allow-Headers: "Accept, Origin, Content-Type, Authorization, X-Requested-With, User-Agent"
          Access-Control-Allow-Credentials: "true"
          Access-Control-Max-Age: "86400"
          
          # GitHub API заголовки
          X-GitHub-Request-Id: ""
          X-RateLimit-Limit: ""
          X-RateLimit-Remaining: ""
          
          # Кэширование для GitHub API
          Cache-Control: "public, max-age=300"
          Vary: "Accept-Encoding, Origin"

