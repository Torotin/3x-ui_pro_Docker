# traefik.yml — оптимизированная статическая конфигурация

# -------------------
# Основные секции
# -------------------
log:
  level: INFO
  # filePath: /logs/traefik.log

accessLog:
  format: "json"
  filePath: /logs/access.log
  filters:
    # Исключить роутеры с отключенным логированием
    # routers:
    #   - "!xhttp3xui-l4"
    #   - "!health-check"
    # Исключить служебные запросы
    statusCodes:
      - "200-299"
      - "300-399"
      - "400-499"
      - "500-599"
    retryAttempts: true
    minDuration: "10ms"

api:
  dashboard: true
  insecure: false

# -------------------
# EntryPoints (оптимизированные)
# -------------------
entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true
    transport:
      respondingTimeouts:
        readTimeout: 30s
        writeTimeout: 30s
        idleTimeout: 180s

  websecure:
    address: ":4443"
    http:
      middlewares:
        - secured-chain@file
        - rate-limit@file
    transport:
      respondingTimeouts:
        readTimeout: 30s
        writeTimeout: 30s
        idleTimeout: 180s
    proxyProtocol:
      trustedIPs:
        - "172.16.0.0/12"
        - "172.18.0.0/16"
        - "172.20.0.0/16"
    http3:
      advertisedPort: 4443

  l4tcp:
    address: ":443"
    transport:
      respondingTimeouts:
        readTimeout: 30s
        writeTimeout: 30s
        idleTimeout: 300s

  l4udp:
    address: ":443/udp"
    transport:
      respondingTimeouts:
        readTimeout: 30s
        writeTimeout: 30s
        idleTimeout: 300s

# -------------------
# Провайдеры (оптимизированные)
# -------------------
providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    network: traefik-proxy
    watch: true
    constraints: "tag==traefik"

  file:
    directory: /dynamic
    watch: true

# -------------------
# ACME / Let's Encrypt (оптимизированный)
# -------------------
certificatesResolvers:
  le:
    acme:
      storage: /acme.json
      httpChallenge:
        entryPoint: web
      keyType: "EC256"
      preferredChain: "ISRG Root X1"

# -------------------
# Плагины (обновленные версии)
# -------------------
experimental:
  plugins:
    bouncer:
      moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
      version: "v1.4.4"
    traefik-plugin-rewrite-headers:
      moduleName: "github.com/XciD/traefik-plugin-rewrite-headers"
      version: "v0.0.4"
    fullUrlRewrite:
      moduleName: "github.com/e-flux-platform/full-url-rewrite-traefik-plugin"
      version: "v0.0.7"