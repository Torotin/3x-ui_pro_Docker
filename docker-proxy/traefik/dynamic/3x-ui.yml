# /dynamic/3x-ui.yml

http:
  services:
    xui-panel-svc:
      loadBalancer:
        servers:
          - url: "http://3x-ui:${PORT_LOCAL_VLESS_PANEL}"
    xui-sub-svc:
      loadBalancer:
        servers:
          - url: "http://3x-ui:${PORT_LOCAL_VLESS_SUBSCRIBE}"
    xhttp3xui-svc:
      loadBalancer:
        servers:
          - url: "http://3x-ui:${PORT_LOCAL_XHTTP}"

  middlewares:
    xui-sub-hostheader:
      headers:
        customRequestHeaders:
          Host: "${WEBDOMAIN}"

    xhttp-headers:
      headers:
        contentTypeNosniff: true
        browserXssFilter: true
        frameDeny: false
        referrerPolicy: "no-referrer-when-downgrade"

        accessControlAllowOriginList: []
        accessControlAllowMethods: []
        accessControlAllowHeaders: []

        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          Cross-Origin-Opener-Policy: "same-origin"
          Cross-Origin-Resource-Policy: "same-origin"
          Permissions-Policy: "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
          server: ""
          x-powered-by: ""
          Access-Control-Allow-Origin: "*"
          Access-Control-Allow-Methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS"
          Access-Control-Allow-Headers: "Accept, Origin, Content-Type, Authorization, X-Requested-With, X-Signalr-User-Agent, Cache-Control, DNT, If-Modified-Since, Keep-Alive, User-Agent, Token, Profile"
          Access-Control-Allow-Credentials: "true"
          Access-Control-Allow-Private-Network: "true"
          Access-Control-Max-Age: "86400"

    xui-assets:
      plugin:
        fullUrlRewrite:
          regex: "^assets/(.*)"
          replacement: "${URI_SUB_PATH}$1"

  routers:
    # Панель 3x-ui (SPA)
    xui-panel:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/${URI_PANEL_PATH}`)"
      entryPoints:
        - websecure
      tls:
        certResolver: le
      service: xui-panel-svc
      priority: 9997

    # Подписки (SUB + JSON)
    xui-sub:
      rule: Host(`${WEBDOMAIN}`) && PathPrefix(`${URI_SUB_PATH}`)
      # rule: Host(`${WEBDOMAIN}`) && (PathPrefix(`${URI_SUB_PATH}`) || PathPrefix(`${URI_JSON_PATH}`))
      entryPoints:
        - websecure
      middlewares:
        - xui-sub-hostheader
      tls:
        certResolver: le
      service: xui-sub-svc
      priority: 9998

    # Статика
    xui-assets:
      rule: Host(`${WEBDOMAIN}`) && PathPrefix(`/assets/`)
      entryPoints:
        - websecure
      middlewares:
        - xui-sub-hostheader
        - xui-assets
      tls:
        certResolver: le
      service: xui-sub-svc
      priority: 9996

    # XHTTP (plain HTTP)
    xhttp3xui-l4:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`${URI_VLESS_XHTTP}`)"
      entryPoints: [l4tcp]
      middlewares:
        - xhttp-headers
      service: xhttp3xui-svc
      priority: 9999
      observability:
        accessLogs: false   # <-- disable access logs for this router only
