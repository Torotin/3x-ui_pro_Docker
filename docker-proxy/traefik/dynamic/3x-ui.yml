# /dynamic/3x-ui.yml

http:
  services:
    3xui-panel-svc:
      loadBalancer:
        servers:
          - url: "http://3x-ui:${PORT_LOCAL_VLESS_PANEL}"
    3xui-sub-svc:
      loadBalancer:
        servers:
          - url: "http://3x-ui:${PORT_LOCAL_VLESS_SUBSCRIBE}"
    3xui-xhttp-svc:
      loadBalancer:
        servers:
          - url: "http://3x-ui:${PORT_LOCAL_XHTTP}"

  middlewares:
    3xui-sub-hostheader:
      headers:
        customRequestHeaders:
          Host: "${WEBDOMAIN}"

  routers:
    # Панель 3x-ui (SPA-путь)
    3xui-panel:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/${URI_PANEL_PATH}`)"
      entryPoints:
        - websecure
      middlewares:
        - secured
      tls:
        certResolver: le
      service: 3xui-panel-svc

    # Подписки (SUB + JSON)
    3xui-sub:
      rule: Host(`${WEBDOMAIN}`) && (PathPrefix(`${URI_SUB_PATH}`) || PathPrefix(`${URI_JSON_PATH}`))
      entryPoints:
        - websecure
      middlewares:
        - secured
        - 3xui-sub-hostheader
      tls:
        certResolver: le
      service: 3xui-sub-svc

    # XHTTP (plain HTTP)
    xhttp3xui:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`${URI_VLESS_XHTTP}`)"
      entryPoints:
        - websecure
      middlewares:
        - secured
      service: 3xui-xhttp-svc
