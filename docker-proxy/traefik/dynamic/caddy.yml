# dynamic/caddy.yml

http:
  services:
    caddy-error:
      loadBalancer:
        servers:
          - url: "http://caddy:${PORT_LOCAL_CADDYWEB}"

  middlewares:
    # Pretty error pages for 4xx/5xx from ANY upstream
    error-pages:
      errors:
        status:
          - "400-599"
        service: caddy-error
        query: "/index.html"

  routers:
    # Fallback site: anything not matched elsewhere goes to Caddy
    catchall:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/`)"
      entryPoints: [websecure]
      tls:
        certResolver: le
      priority: -1
      middlewares:
        - error-pages            # ошибки оформлять через /index.html
      service: caddy-error

    # Отдача favicon напрямую из Caddy, чтобы не светить 404
    favicon:
      rule: "Host(`${WEBDOMAIN}`) && Path(`/favicon.ico`)"
      entryPoints: [websecure]
      tls:
        certResolver: le
      priority: 1                # выше catchall
      service: caddy-error       # Caddy вернёт /favicon.ico из /www
      