# dynamic/caddy.yml

http:
  services:
    caddy-error:
      loadBalancer:
        servers:
          - url: "http://caddy:${PORT_LOCAL_CADDYWEB}"
        healthCheck:
          path: "/index.html"
          interval: "10s"
          timeout: "2s"

  middlewares:
    error-pages:
      errors:
        status:
          - "400-599"
        service: caddy-error
        query: "/index.html"

    redirect-to-caddy:
      plugin:
        traefik-plugin-rewrite-headers:
          rewrites:
            # https://example.com/foo -> /foo
            - header: "Location"
              regex: "^https?://(${WEBDOMAIN})(/.*)?$"
              replacement: "$2"
            # На всякий: //example.com/foo -> /foo
            - header: "Location"
              regex: "^//(${WEBDOMAIN})(/.*)?$"
              replacement: "$2"
  routers:
    favicon:
      rule: "Host(`${WEBDOMAIN}`) && Path(`/favicon.ico`)"
      entryPoints: [websecure]
      tls:
        certResolver: le
      priority: 1
      service: caddy-error

    catchall:
      rule: "Host(`${WEBDOMAIN}`) && PathPrefix(`/`)"
      entryPoints: [websecure]
      tls:
        certResolver: le
      priority: -1
      middlewares:
        - error-pages
        - redirect-to-caddy
      service: caddy-error
